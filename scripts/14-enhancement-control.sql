-- ================================================================
-- 14-enhancement-control.sql
-- PostgreSQL RustÊâ©Â±ïÂ¢ûÂº∫ÊéßÂà∂Á≥ªÁªü
-- Êèê‰æõÂú®ÂéüÊúâÂü∫Á°Ä‰∏äÁöÑÊÄßËÉΩÂíåÂäüËÉΩÂ¢ûÂº∫
-- ================================================================

-- ÂàõÂª∫Â¢ûÂº∫ÁÆ°ÁêÜÊû∂ÊûÑ
CREATE SCHEMA IF NOT EXISTS enhancement_control;
COMMENT ON SCHEMA enhancement_control IS 'RustÊâ©Â±ïÂ¢ûÂº∫ÊéßÂà∂ÂíåÁÆ°ÁêÜÁ≥ªÁªü';

-- ================================================================
-- ÂäüËÉΩÂ¢ûÂº∫ÁÆ°ÁêÜË°®
-- ================================================================

-- ÂäüËÉΩÂ¢ûÂº∫ÈÖçÁΩÆË°®
CREATE TABLE enhancement_control.feature_enhancements (
    feature_name TEXT PRIMARY KEY,
    original_implementation TEXT NOT NULL, -- ÂéüÂßãÂÆûÁé∞ÊèèËø∞
    rust_enhancement TEXT,                 -- RustÂ¢ûÂº∫ÁâàÊú¨
    enhancement_type TEXT CHECK (enhancement_type IN ('performance', 'feature', 'security')) NOT NULL,
    active_mode TEXT CHECK (active_mode IN ('original', 'enhanced', 'adaptive')) DEFAULT 'original',
    enhancement_status TEXT CHECK (enhancement_status IN ('planning', 'testing', 'active', 'deprecated')) DEFAULT 'planning',
    performance_gain DOUBLE PRECISION DEFAULT 1.0, -- ÊÄßËÉΩÊèêÂçáÂÄçÊï∞
    memory_improvement DOUBLE PRECISION DEFAULT 1.0, -- ÂÜÖÂ≠ò‰ΩøÁî®ÊîπÂñÑ
    safety_level TEXT CHECK (safety_level IN ('low', 'medium', 'high', 'critical')) DEFAULT 'medium',
    rust_extension_name TEXT, -- ÂØπÂ∫îÁöÑRustÊâ©Â±ïÂêçÁß∞
    fallback_enabled BOOLEAN DEFAULT true, -- ÊòØÂê¶ÂêØÁî®ÂõûÈÄÄÊú∫Âà∂
    auto_switch_threshold INTEGER DEFAULT 10000, -- Ëá™Âä®ÂàáÊç¢ÁöÑÊï∞ÊçÆÈáèÈòàÂÄº
    last_updated TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

COMMENT ON TABLE enhancement_control.feature_enhancements IS 'ÂäüËÉΩÂ¢ûÂº∫ÈÖçÁΩÆÁÆ°ÁêÜË°®';
COMMENT ON COLUMN enhancement_control.feature_enhancements.performance_gain IS 'Áõ∏ÊØîÂéüÂßãÂÆûÁé∞ÁöÑÊÄßËÉΩÊèêÂçáÂÄçÊï∞';
COMMENT ON COLUMN enhancement_control.feature_enhancements.auto_switch_threshold IS 'Â§ß‰∫éÊ≠§Êï∞ÊçÆÈáèÊó∂Ëá™Âä®ÂàáÊç¢Âà∞Â¢ûÂº∫ÁâàÊú¨';

-- ÊÄßËÉΩÂØπÊØîÁõëÊéßË°®
CREATE TABLE enhancement_control.performance_comparison (
    id SERIAL PRIMARY KEY,
    feature_name TEXT NOT NULL,
    test_scenario TEXT NOT NULL,
    implementation_type TEXT CHECK (implementation_type IN ('original', 'enhanced')) NOT NULL,
    execution_time_ms DOUBLE PRECISION,
    memory_usage_mb DOUBLE PRECISION,
    cpu_usage_percent DOUBLE PRECISION,
    throughput_ops_sec DOUBLE PRECISION,
    data_size INTEGER,
    concurrent_users INTEGER DEFAULT 1,
    error_count INTEGER DEFAULT 0,
    success_count INTEGER DEFAULT 1,
    test_timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    environment TEXT DEFAULT 'production' -- 'development', 'testing', 'production'
);

COMMENT ON TABLE enhancement_control.performance_comparison IS 'ÊÄßËÉΩÂØπÊØîÁõëÊéßÊï∞ÊçÆË°®';

-- Â¢ûÂº∫‰ΩøÁî®ÁªüËÆ°Ë°®
CREATE TABLE enhancement_control.usage_statistics (
    id SERIAL PRIMARY KEY,
    feature_name TEXT NOT NULL,
    implementation_used TEXT NOT NULL, -- 'original', 'enhanced', 'auto_selected'
    usage_timestamp TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    session_id TEXT,
    user_id TEXT,
    query_parameters JSONB,
    execution_context TEXT -- Ë∞ÉÁî®‰∏ä‰∏ãÊñá‰ø°ÊÅØ
);

COMMENT ON TABLE enhancement_control.usage_statistics IS 'Â¢ûÂº∫ÂäüËÉΩ‰ΩøÁî®ÁªüËÆ°Ë°®';

-- ================================================================
-- Ê†∏ÂøÉÂ¢ûÂº∫ÊéßÂà∂ÂáΩÊï∞
-- ================================================================

-- Ëá™ÈÄÇÂ∫îÊÄßËÉΩÈÄâÊã©ÂáΩÊï∞
CREATE OR REPLACE FUNCTION enhancement_control.adaptive_performance_selector(
    feature_name TEXT,
    data_size INTEGER DEFAULT 0,
    performance_requirement TEXT DEFAULT 'balanced', -- 'stability', 'balanced', 'performance'
    force_enhanced BOOLEAN DEFAULT false
)
RETURNS TEXT AS $$
DECLARE
    enhancement_config RECORD;
    selection TEXT;
BEGIN
    -- Ëé∑ÂèñÂ¢ûÂº∫ÈÖçÁΩÆ
    SELECT * INTO enhancement_config
    FROM enhancement_control.feature_enhancements
    WHERE feature_enhancements.feature_name = adaptive_performance_selector.feature_name;

    -- Â¶ÇÊûúÊ≤°ÊúâÈÖçÁΩÆÔºåËøîÂõûÂéüÂßãÂÆûÁé∞
    IF NOT FOUND THEN
        RETURN 'original';
    END IF;

    -- Ê£ÄÊü•RustÂ¢ûÂº∫ÊòØÂê¶ÂèØÁî®‰∏îÂ§Ñ‰∫éÊ¥ªË∑ÉÁä∂ÊÄÅ
    IF enhancement_config.rust_enhancement IS NULL
       OR enhancement_config.enhancement_status NOT IN ('testing', 'active') THEN
        RETURN 'original';
    END IF;

    -- Âº∫Âà∂‰ΩøÁî®Â¢ûÂº∫ÁâàÊú¨
    IF force_enhanced THEN
        RETURN 'enhanced';
    END IF;

    -- Ê†πÊçÆÊÄßËÉΩË¶ÅÊ±ÇÂíåÊï∞ÊçÆÈáèÊô∫ËÉΩÈÄâÊã©
    CASE performance_requirement
        WHEN 'stability' THEN
            -- Á®≥ÂÆöÊÄß‰ºòÂÖàÔºöÂßãÁªà‰ΩøÁî®ÂéüÊúâÂÆûÁé∞
            selection := 'original';

        WHEN 'performance' THEN
            -- ÊÄßËÉΩ‰ºòÂÖàÔºöÂ∞ΩÂèØËÉΩ‰ΩøÁî®Â¢ûÂº∫ÁâàÊú¨
            selection := CASE
                WHEN enhancement_config.enhancement_status = 'active' THEN 'enhanced'
                ELSE 'original'
            END;

        ELSE -- 'balanced'
            -- Âπ≥Ë°°Ê®°ÂºèÔºöÊ†πÊçÆÊï∞ÊçÆÈáèÂíåÂÆâÂÖ®Á∫ßÂà´Êô∫ËÉΩÈÄâÊã©
            selection := CASE
                WHEN enhancement_config.enhancement_status = 'active'
                     AND data_size >= enhancement_config.auto_switch_threshold
                     AND enhancement_config.safety_level IN ('medium', 'high', 'critical')
                THEN 'enhanced'
                WHEN enhancement_config.enhancement_status = 'active'
                     AND enhancement_config.safety_level = 'high'
                     AND data_size >= (enhancement_config.auto_switch_threshold / 2)
                THEN 'enhanced'
                ELSE 'original'
            END;
    END CASE;

    -- ËÆ∞ÂΩïÈÄâÊã©ÂÜ≥Á≠ñ
    INSERT INTO enhancement_control.usage_statistics
    (feature_name, implementation_used, query_parameters, execution_context)
    VALUES (
        adaptive_performance_selector.feature_name,
        'auto_selected_' || selection,
        jsonb_build_object(
            'data_size', data_size,
            'performance_requirement', performance_requirement,
            'force_enhanced', force_enhanced,
            'auto_threshold', enhancement_config.auto_switch_threshold
        ),
        'adaptive_selector'
    );

    RETURN selection;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION enhancement_control.adaptive_performance_selector IS
'Êô∫ËÉΩÈÄâÊã©ÂéüÂßãÂÆûÁé∞ÊàñÂ¢ûÂº∫ÂÆûÁé∞ÔºåÂü∫‰∫éÊï∞ÊçÆÈáè„ÄÅÊÄßËÉΩË¶ÅÊ±ÇÂíåÂÆâÂÖ®Á∫ßÂà´';

-- Â¢ûÂº∫ÊïàÊûúÂàÜÊûêÂáΩÊï∞
CREATE OR REPLACE FUNCTION enhancement_control.analyze_enhancement_impact(
    feature_name TEXT,
    time_window INTERVAL DEFAULT '24 hours'
)
RETURNS TABLE(
    implementation TEXT,
    avg_performance_ms DOUBLE PRECISION,
    improvement_factor DOUBLE PRECISION,
    usage_count INTEGER,
    success_rate DOUBLE PRECISION,
    avg_throughput DOUBLE PRECISION
) AS $$
BEGIN
    RETURN QUERY
    WITH performance_stats AS (
        SELECT
            pc.implementation_type,
            AVG(pc.execution_time_ms) as avg_perf,
            AVG(pc.throughput_ops_sec) as avg_throughput,
            COUNT(*) as usage,
            AVG(CASE WHEN pc.error_count = 0 THEN 1.0 ELSE 0.0 END) as success_rate
        FROM enhancement_control.performance_comparison pc
        WHERE pc.feature_name = analyze_enhancement_impact.feature_name
          AND pc.test_timestamp > NOW() - time_window
        GROUP BY pc.implementation_type
    ),
    baseline AS (
        SELECT
            avg_perf as baseline_perf,
            avg_throughput as baseline_throughput
        FROM performance_stats
        WHERE implementation_type = 'original'
    )
    SELECT
        ps.implementation_type,
        ps.avg_perf,
        CASE
            WHEN ps.implementation_type = 'original' THEN 1.0
            ELSE COALESCE(b.baseline_perf / NULLIF(ps.avg_perf, 0), 1.0)
        END as improvement,
        ps.usage::INTEGER,
        ps.success_rate,
        ps.avg_throughput
    FROM performance_stats ps
    LEFT JOIN baseline b ON true
    ORDER BY ps.implementation_type;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION enhancement_control.analyze_enhancement_impact IS
'ÂàÜÊûêÂ¢ûÂº∫ÂäüËÉΩÁöÑÊÄßËÉΩÂΩ±ÂìçÂíå‰ΩøÁî®ÁªüËÆ°';

-- Â¢ûÂº∫ÊéßÂà∂‰∏ªÂáΩÊï∞
CREATE OR REPLACE FUNCTION enhancement_control.control_enhancement(
    feature_name TEXT,
    action TEXT -- 'enable_enhanced', 'enable_adaptive', 'use_original', 'status', 'benchmark', 'configure'
)
RETURNS TEXT AS $$
DECLARE
    result TEXT;
    config RECORD;
BEGIN
    CASE action
        WHEN 'enable_enhanced' THEN
            UPDATE enhancement_control.feature_enhancements
            SET active_mode = 'enhanced',
                enhancement_status = 'active',
                last_updated = NOW()
            WHERE feature_enhancements.feature_name = control_enhancement.feature_name;

            GET DIAGNOSTICS result = ROW_COUNT;
            IF result::INTEGER > 0 THEN
                result := format('‚úÖ Enhanced mode enabled for %s', feature_name);
            ELSE
                result := format('‚ùå Feature %s not found', feature_name);
            END IF;

        WHEN 'enable_adaptive' THEN
            UPDATE enhancement_control.feature_enhancements
            SET active_mode = 'adaptive',
                enhancement_status = 'active',
                last_updated = NOW()
            WHERE feature_enhancements.feature_name = control_enhancement.feature_name;

            GET DIAGNOSTICS result = ROW_COUNT;
            IF result::INTEGER > 0 THEN
                result := format('üß† Adaptive mode enabled for %s', feature_name);
            ELSE
                result := format('‚ùå Feature %s not found', feature_name);
            END IF;

        WHEN 'use_original' THEN
            UPDATE enhancement_control.feature_enhancements
            SET active_mode = 'original',
                last_updated = NOW()
            WHERE feature_enhancements.feature_name = control_enhancement.feature_name;

            GET DIAGNOSTICS result = ROW_COUNT;
            IF result::INTEGER > 0 THEN
                result := format('üîÑ Using original implementation for %s', feature_name);
            ELSE
                result := format('‚ùå Feature %s not found', feature_name);
            END IF;

        WHEN 'benchmark' THEN
            -- Ëß¶ÂèëÊÄßËÉΩÂØπÊØîÊµãËØï
            INSERT INTO enhancement_control.performance_comparison
            (feature_name, test_scenario, implementation_type, test_timestamp)
            VALUES (feature_name, 'manual_benchmark', 'original', NOW());

            result := format('üìä Benchmark initiated for %s', feature_name);

        WHEN 'status' THEN
            SELECT
                format('üéØ Feature: %s | Mode: %s | Enhancement: %s | Status: %s | Gain: %.2fx | Safety: %s',
                    fe.feature_name,
                    fe.active_mode,
                    fe.enhancement_type,
                    fe.enhancement_status,
                    COALESCE(fe.performance_gain, 1.0),
                    fe.safety_level
                )
            INTO result
            FROM enhancement_control.feature_enhancements fe
            WHERE fe.feature_name = control_enhancement.feature_name;

            IF result IS NULL THEN
                result := format('‚ùå Feature %s not found', feature_name);
            END IF;

        WHEN 'configure' THEN
            result := format('‚öôÔ∏è Configuration interface for %s (use specific config functions)', feature_name);

        ELSE
            result := format('‚ùå Unknown action: %s. Available: enable_enhanced, enable_adaptive, use_original, status, benchmark', action);
    END CASE;

    RETURN result;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION enhancement_control.control_enhancement IS
'Â¢ûÂº∫ÂäüËÉΩÊéßÂà∂‰∏ªÂáΩÊï∞ÔºåÊîØÊåÅÂêØÁî®„ÄÅÈÖçÁΩÆ„ÄÅÁä∂ÊÄÅÊü•ËØ¢Á≠âÊìç‰Ωú';

-- ================================================================
-- ÊÄßËÉΩÁõëÊéßÂíåÊä•ÂëäÂáΩÊï∞
-- ================================================================

-- ÂÆûÊó∂ÊÄßËÉΩÁõëÊéßËßÜÂõæ
CREATE OR REPLACE VIEW enhancement_control.live_performance_monitor AS
SELECT
    fe.feature_name,
    fe.active_mode,
    fe.enhancement_status,
    fe.performance_gain,
    COALESCE(recent_stats.usage_last_hour, 0) as usage_last_hour,
    COALESCE(recent_stats.avg_performance_ms, 0) as avg_performance_ms,
    COALESCE(recent_stats.success_rate, 100.0) as success_rate_percent
FROM enhancement_control.feature_enhancements fe
LEFT JOIN (
    SELECT
        pc.feature_name,
        COUNT(*) as usage_last_hour,
        AVG(pc.execution_time_ms) as avg_performance_ms,
        AVG(CASE WHEN pc.error_count = 0 THEN 100.0 ELSE 0.0 END) as success_rate
    FROM enhancement_control.performance_comparison pc
    WHERE pc.test_timestamp > NOW() - INTERVAL '1 hour'
    GROUP BY pc.feature_name
) recent_stats ON fe.feature_name = recent_stats.feature_name
ORDER BY fe.feature_name;

COMMENT ON VIEW enhancement_control.live_performance_monitor IS
'ÂÆûÊó∂ÊÄßËÉΩÁõëÊéßËßÜÂõæÔºåÊòæÁ§∫ÊâÄÊúâÂ¢ûÂº∫ÂäüËÉΩÁöÑÂΩìÂâçÁä∂ÊÄÅÂíåÊÄßËÉΩÊåáÊ†á';

-- Â¢ûÂº∫ÈÖçÁΩÆÊä•ÂëäÂáΩÊï∞
CREATE OR REPLACE FUNCTION enhancement_control.enhancement_report()
RETURNS TABLE(
    feature TEXT,
    mode TEXT,
    status TEXT,
    enhancement TEXT,
    performance_gain TEXT,
    safety TEXT,
    last_updated TEXT
) AS $$
BEGIN
    RETURN QUERY
    SELECT
        fe.feature_name,
        fe.active_mode,
        fe.enhancement_status,
        fe.enhancement_type,
        COALESCE(fe.performance_gain::TEXT || 'x', 'N/A'),
        fe.safety_level,
        fe.last_updated::TEXT
    FROM enhancement_control.feature_enhancements fe
    ORDER BY
        CASE fe.enhancement_status
            WHEN 'active' THEN 1
            WHEN 'testing' THEN 2
            WHEN 'planning' THEN 3
            WHEN 'deprecated' THEN 4
        END,
        fe.performance_gain DESC;
END;
$$ LANGUAGE plpgsql;

COMMENT ON FUNCTION enhancement_control.enhancement_report IS
'ÁîüÊàêÂ¢ûÂº∫ÂäüËÉΩÈÖçÁΩÆÂíåÁä∂ÊÄÅÁöÑÂÆåÊï¥Êä•Âëä';

-- ================================================================
-- ÂàùÂßãÂåñÂ¢ûÂº∫ÈÖçÁΩÆ
-- ================================================================

-- ÊèíÂÖ•È¢ÑÂÆö‰πâÁöÑÂ¢ûÂº∫ÈÖçÁΩÆ
INSERT INTO enhancement_control.feature_enhancements
(feature_name, original_implementation, rust_enhancement, enhancement_type, active_mode, enhancement_status, performance_gain, memory_improvement, safety_level, rust_extension_name, auto_switch_threshold)
VALUES
    ('uuid_generation',
     'uuid-ossp v4 random UUID',
     'pg_uuidv7 time-ordered UUID with better clustering',
     'feature',
     'original',
     'planning',
     1.2,
     1.0,
     'high',
     'pg_uuidv7',
     1000),

    ('vector_search',
     'pgvector basic similarity search',
     'pgvecto.rs high-performance vector operations with SIMD',
     'performance',
     'original',
     'planning',
     28.0,
     1.5,
     'medium',
     'vectors',
     10000),

    ('string_processing',
     'Basic SQL string functions',
     'pg_str Laravel-style string manipulation API',
     'feature',
     'original',
     'planning',
     5.0,
     1.2,
     'high',
     'pg_str',
     5000),

    ('sequence_analysis',
     'SQL-based biological sequence calculations',
     'Rust SIMD-optimized sequence processing',
     'performance',
     'original',
     'planning',
     50.0,
     2.0,
     'medium',
     'bio_postgres',
     1000),

    ('analytics_engine',
     'TimescaleDB OLAP components',
     'pg_analytics DuckDB-powered analytical engine',
     'performance',
     'original',
     'planning',
     15.0,
     1.8,
     'medium',
     'pg_analytics',
     50000),

    ('iot_data_processing',
     'JSON + HStore device data handling',
     'pg_iot native device protocol parsing',
     'feature',
     'original',
     'planning',
     8.0,
     1.3,
     'medium',
     'pg_iot',
     20000)
ON CONFLICT (feature_name) DO UPDATE SET
    last_updated = NOW();

-- ÂàõÂª∫Á¥¢Âºï‰ºòÂåñÊü•ËØ¢ÊÄßËÉΩ
CREATE INDEX IF NOT EXISTS idx_feature_enhancements_active_mode
    ON enhancement_control.feature_enhancements(active_mode);

CREATE INDEX IF NOT EXISTS idx_performance_comparison_feature_timestamp
    ON enhancement_control.performance_comparison(feature_name, test_timestamp);

CREATE INDEX IF NOT EXISTS idx_usage_statistics_feature_timestamp
    ON enhancement_control.usage_statistics(feature_name, usage_timestamp);

-- ÊòæÁ§∫ÂàùÂßãÂåñÁªìÊûú
SELECT
    'üéâ Enhancement Control System Initialized!' as message,
    COUNT(*) as features_configured
FROM enhancement_control.feature_enhancements;

SELECT
    'üìä Current Enhancement Status:' as status_report,
    feature_name,
    active_mode,
    enhancement_status,
    performance_gain || 'x improvement' as benefit
FROM enhancement_control.feature_enhancements
ORDER BY performance_gain DESC;
